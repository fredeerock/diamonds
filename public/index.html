<!doctype html>
<html> 
	<head>
		<meta charset="utf-8">
		<title>Causeway</title>
		<!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


		<link rel="stylesheet" href="styles/main.css">

		<link href='http://fonts.googleapis.com/css?family=Vollkorn' rel='stylesheet' type='text/css'>

		<script src="/socket.io/socket.io.js"></script>
		<script type="text/javascript" src="js/Tone.min.js"></script>
		
	</head>
	<body>
		<div class="sec sw">

			<h1 onclick="causeSound.triggerCauseway();"><span class="mainTitle">Causeway</span></h1>
			
			<div class="sd">

			</div>

			<div class="st" style="display: none;">
				

			</div>

		</div>

		<div id="causeway-text"></div>

		<script>
			var socket = io.connect('127.0.0.1:8000');
			// var socket = io.connect('https://atlab.cct.lsu.edu/', { path: '/causeway/socket.io' });
			var myColor = getRandomColor();
			var myLocation = [0.5, 0.5];	// Default centered

			document.getElementsByTagName("body")[0].style.borderLeft = "15px solid " + myColor;
			// seatMap.addEventListener("click", getClickPosition, false);

			function getClickPosition(e) {
				var m = seatMap.getScreenCTM();
				var p = document.getElementById('seatMap').createSVGPoint(); 
				p.x = e.clientX;
				p.y = e.clientY;
				p = p.matrixTransform(m.inverse());
				var tx = document.getElementById('seatMap').getAttribute("viewBox").split(" ")[2]; 
				var ty = document.getElementById('seatMap').getAttribute("viewBox").split(" ")[3];
				var mx = p.x/tx;
				var my = p.y/ty;
				
				myLocation[0] = mx;
				myLocation[1] = my;
				console.log(myLocation);

				registerWithServer();
			}

			function registerWithServer() {
				Tone.startMobile();
				causeSound.triggerPitch();
				// causeSound.triggerCauseway();
				socket.emit('addme', {name: "a_user", color: myColor, note: causeSound.pitch, location: myLocation});
				// document.getElementsByClassName("sd")[0].style.display = 'none';
				// document.getElementsByClassName("st")[0].style.display = 'block';
			}
			
			socket.on('chat', function(data){
				console.log("chat: " + data);
			});

			socket.on('setSection', function(data) {
				console.log(data);
				console.log("the section is now: " + data.title);

				if (data.sect == "15") {
					// Tone.startMobile();
					causeSound.playBrought();
				}
				
				// if(data.title !== undefined){
				// 	var otherClasses = document.querySelectorAll('.sec');

				// 	for (var i = 0; i < otherClasses.length; i++) {
				// 	    otherClasses[i].style.display = 'none';
				// 	}

				// 	document.getElementsByClassName("s"+data.sect)[0].style.display = 'block';
				// }
				
			});

			function scrollto(element){ 
				var ele = document.getElementsByClassName("s"+element)[0];
			    if (ele) {
			    	window.scrollTo(0, ele.offsetTop);
			    }
			}

			socket.on('itemback', function(data){
				console.log("itemback: " + data.phrase);

				var elements = document.getElementsByClassName(data.phrase);
				elements[0].className += " clicked";
			});

			function clickgo() {
				var elements = document.getElementsByClassName(this.className);
				socket.emit('item', elements[0].className.split(" ")[1]);
				elements[0].className += " clicked";
				elements[0].style.backgroundColor = myColor;
			}

			window.onload = function() {
				var xhr= new XMLHttpRequest();
				xhr.open('GET', 'data/score.txt', true);
				xhr.onreadystatechange= function() {
				    if (this.readyState!==4) return;
				    if (this.status!==200) return;
				    document.getElementById("causeway-text").innerHTML= this.responseText;
				    addEvents();
				};
				xhr.send();

				function addEvents() {
					var phrases = document.getElementsByClassName('phrase');
					for (var i = 0; i < phrases.length; i++) {
						phrases[i].addEventListener("click", clickgo, false);
					}
				}

			};

			function getRandomColor() {
				var letters = '0123456789ABCDEF'.split('');
				var color = '#';
				for (var i = 0; i < 6; i++ ) {
				    color += letters[Math.floor(Math.random() * 16)];
				}
				return color;
			}

			var CauseSound = function () {
				this.tone = new Tone();
				this.synth = new Tone.SimpleSynth({
					"oscillator" : {
						"type" : "sine"
				 },
				 "envelope" : {
				 	"attack" : 2.0,
					"decay" : 0.5,
					"sustain" : 0.8,
					"release" : 2.0
				 }
				}).toMaster();
				
				this.player = new Tone.Player("data/wavs/001-Causeway.wav").toMaster();
				this.player2 = new Tone.Player("data/wavs/204-who%20had%20brought%20this%20one%20.wav").toMaster();

				
				this.pitchCollection = [55, 57, 59, 61, 62, 64, 66, 67, 68, 69, 71, 73, 75, 76, 78, 80, 82, 83];
				
				this.pitch = this.pitchCollection[Math.floor(Math.random() * (this.pitchCollection.length))];
				
				
				this.playPitch = function () {
					this.synth.triggerAttackRelease(this.tone.midiToNote(this.pitch+12), 5);
				};

				this.triggerPitch = function () {
					this.synth.triggerAttackRelease(this.tone.midiToNote(this.pitch+12), 5);
					socket.emit('triggerPitch', causeSound.pitch);
				};
				
				this.playCauseway = function() {
					this.player.start();
				};

				this.playBrought = function() {
					this.player2.start();
				};
				
				this.triggerCauseway = function() {
					this.synth.triggerAttackRelease(this.tone.midiToNote(this.pitch+12), 5);
					this.player.start();
					socket.emit('triggerCauseway', causeSound.pitch);
					
					var elements = document.getElementsByClassName("mainTitle");
					// elements[0].className += " clicked";
					elements[0].style.backgroundColor = myColor;
				};
			};
			
			var causeSound = new CauseSound();
			
		</script>

	</body>
</html>
