<!doctype html>
<html> 
<head>
	<meta charset="utf-8">
	<title>Diamonds</title>
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" /> -->

	<link rel="stylesheet" href="styles/main.css">

	<link href='http://fonts.googleapis.com/css?family=Vollkorn' rel='stylesheet' type='text/css'>

	<script src="/socket.io/socket.io.js"></script>
	<!-- <script type="text/javascript" src="js/Tone.min.js"></script> -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript" src="scripts/mespeak/mespeak.full.min.js"></script>
	<script type="text/javascript" src="scripts/Tone.js"></script>
</head>

<body>	
	<div class="wrapper">	
	<div class="welcomeText">
		<h1>Bound by Digital Countries</h1>
		<p>Words | <strong>Vincent A. Cellucci</strong></p>
		<p>Audio | <strong>Jesse Allison</strong></p>
		<p>Visuals | <strong>Derick Ostrenko</strong></p>
		<p>UnMute your phone and Turn up your volume.</p>
		<p>Then tap the button to begin.</p>
		<p><button style="height:200px;width:200px" onclick="Tone.startMobile();document.getElementsByClassName('welcomeText')[0].style.display = 'none';document.getElementsByClassName('scoreText')[0].style.display = 'block';"><span style="font-size:3em">Start</span></button></p>
		<p><em>Tapping is the new snapping!</em></p>
	</div>

	<div class="scoreText"></div>
<script>

// (function($) {

//     function getTextWidth($element) {
//         var tester = $("<div/>").text($element.text())
// 			.css({ "position": "absolute", "float": "left", "white-space": "nowrap", "visibility": "hidden", "font": $element.css("font"), "text-transform": $element.css("text-transform"), "letter-spacing": $element.css("letter-spacing") })
// 			.appendTo($element.parent()),
// 			width = tester.innerWidth();
//         tester.remove();
//         return width;
//     }

//     function AutoShrinker($element) {
//         this.$element = $element;
//         this.$parent = $element.parent();
//         this.initialFontSize = parseFloat($element.css("fontSize"));
//         this.currentFontSize = this.initialFontSize;
//         this.leftMarginRatio = parseFloat($element.css("marginLeft")) / this.initialFontSize;
//         this.resize = function() {
//             var maxWidth = this.$parent.width(),
// 				newSize = this.currentFontSize * (maxWidth / getTextWidth(this.$element));
//             newSize = newSize > this.initialFontSize ? this.initialFontSize : newSize;
//             this.$element.css({
//                 "fontSize": newSize,
//                 "marginLeft": newSize * this.leftMarginRatio
//             });
//             this.currentFontSize = newSize;
//         };
//     }

//     $.fn.autoshrink = function() {
//         return this.each(function() {
//             var shrinker, $this = $(this);
//             $this.data("autoshrinker", shrinker = new AutoShrinker($this));
//             shrinker.resize();
//             $(window).on("resize", function() {
//                 shrinker.resize();
//             });
//         });
//     };
// })(jQuery);

// $(".welcomeText").autoshrink();


var colors = new Array(
  [62,35,255],
  [60,255,60],
  [255,35,98],
  [45,175,230],
  [255,0,255],
  [255,128,0]);

var step = 0;
// color table indices for: 
// current color left
// next color left
// current color right
// next color right
var colorIndices = [0,1,2,3];

//transition speed
var gradientSpeed = 0.002;

function updateGradient() {
  
	if ( $===undefined ) return;
  
	var c0_0 = colors[colorIndices[0]];
	var c0_1 = colors[colorIndices[1]];
	var c1_0 = colors[colorIndices[2]];
	var c1_1 = colors[colorIndices[3]];

	var istep = 1 - step;
	var r1 = Math.round(istep * c0_0[0] + step * c0_1[0]);
	var g1 = Math.round(istep * c0_0[1] + step * c0_1[1]);
	var b1 = Math.round(istep * c0_0[2] + step * c0_1[2]);
	var color1 = "rgb("+r1+","+g1+","+b1+")";

	var r2 = Math.round(istep * c1_0[0] + step * c1_1[0]);
	var g2 = Math.round(istep * c1_0[1] + step * c1_1[1]);
	var b2 = Math.round(istep * c1_0[2] + step * c1_1[2]);
	var color2 = "rgb("+r2+","+g2+","+b2+")";

	$('body')
	.css({background: "-webkit-gradient(linear, left top, right top, from("+color1+"), to("+color2+"))"})
	.css({background: "-moz-linear-gradient(left, "+color1+" 0%, "+color2+" 100%)"});
	  
	step += gradientSpeed;

	if ( step >= 1 ) {
		step %= 1;
		colorIndices[0] = colorIndices[1];
		colorIndices[2] = colorIndices[3];

		//pick two new target color indices
		//do not pick the same as the current one
		colorIndices[1] = ( colorIndices[1] + Math.floor( 1 + Math.random() * (colors.length - 1))) % colors.length;
		colorIndices[3] = ( colorIndices[3] + Math.floor( 1 + Math.random() * (colors.length - 1))) % colors.length;
	}
}

setInterval(updateGradient,10);

// var socket = io.connect('127.0.0.1:8000');
var socket = io.connect(window.location.origin , {transports:['websocket']} );
// var socket = io.connect('https://atlab.cct.lsu.edu/', { path: '/causeway/socket.io' });
var myColor = getRandomColor();
var myLocation = [0.5, 0.5];	// Default centered

// seatMap.addEventListener("click", getClickPosition, false);

// $(function () {
function actOnText() {
	var contents = $('.scoreText').text().split(" "),
	modText = '';

	for (var i = 0; i < contents.length; i++) {
		modText += '<span>' + contents[i] + '</span> ';
	}

	$('.scoreText').html(modText);

}

$('.scoreText').click(function (e) {
	target = event.target || event.srcElement;

	if (target.nodeName.toLowerCase() === "span") {
		var text = $(e.target).text();
	
		console.log("text:",text);
		$(e.target).toggleClass('underline');
		// $(e.target).style.color=myColor;
		// console.log(myColor);
		dSound.speak(text);
		socket.emit('item', text);
	}
});

function registerWithServer() {
	// Tone.startMobile();
	// causeSound.triggerPitch();
	// causeSound.triggerCauseway();
	socket.emit('addme', {name: "a_user", color: myColor});
	// document.getElementsByClassName("sd")[0].style.display = 'none';
	// document.getElementsByClassName("st")[0].style.display = 'block';
}

socket.on('chat', function(data){
	console.log("chat: " + data);
});

socket.on('setSection', function(data) {
	// console.log(data);
	console.log("the section is now: " + data.title);

	// if (data.sect == "15") {
	// 	Tone.startMobile();
	// 	causeSound.playBrought();
	// }
	
	// if(data.title !== undefined){
	// 	var otherClasses = document.querySelectorAll('.sec');

	// 	for (var i = 0; i < otherClasses.length; i++) {
	// 	    otherClasses[i].style.display = 'none';
	// 	}

	// 	document.getElementsByClassName("s"+data.sect)[0].style.display = 'block';
	// }
	
});

// function scrollto(element){ 
// 	var ele = document.getElementsByClassName("s"+element)[0];
//     if (ele) {
//     	window.scrollTo(0, ele.offsetTop);
//     }
// }

socket.on('itemback', function(data){
	// console.log("itemback: " + data.phrase);
	// var elements = document.getElementsByClassName(data.phrase);
	// elements[0].className += " clicked";
});

// function clickgo() {
// 	var elements = document.getElementsByClassName(this.className);
// 	socket.emit('item', elements[0].className.split(" ")[1]);
// 	elements[0].className += " clicked";
// 	elements[0].style.backgroundColor = myColor;
// }

socket.on('triggerBeginning', function(data) {
	dSound.playKepler();
});

socket.on('nextChord', function(data) {
	dSound.nextChord();
});

socket.on('triggerUtopalypse', function(data) {
	dSound.playUtopalypse();
});

socket.on('triggerDiamonds', function(data) {
	dSound.playDiamonds();
});

socket.on('triggerEnding', function(data) {
	dSound.playEnding();
});



window.onload = function() {
	registerWithServer();
	var xhr= new XMLHttpRequest();
	xhr.open('GET', 'data/score.txt', true);
	xhr.onreadystatechange= function() {
	    if (this.readyState!==4) return;
	    if (this.status!==200) return;
	    var scoreText = document.getElementsByClassName("scoreText")[0];
	    scoreText.innerHTML= this.responseText;
	    // $(".scoreText").textfill();
	    actOnText();
	    document.getElementsByTagName("html")[0].style.borderLeft = "15px solid " + myColor;

	    // .style.display = 'block'
	    // addEvents();
	};
	xhr.send();

	// function addEvents() {
	// 	var phrases = document.getElementsByClassName('phrase');
	// 	for (var i = 0; i < phrases.length; i++) {
	// 		phrases[i].addEventListener("click", clickgo, false);
	// 	}
	// }

};

$(window).resize(function() {
		    // document.getElementsByTagName("body")[0].style.borderLeft = "15px solid " + myColor;
		    // console.log("resized");
});

function getRandomColor() {
	var letters = '0123456789ABCDEF'.split('');
	var color = '#';
	for (var i = 0; i < 6; i++ ) {
	    color += letters[Math.floor(Math.random() * 16)];
	}
	return color;
}


	// Add Chords, Progression, feedback, comb filtering, shimmer!
	
	var self = this;
	
	var speakVoice = 'en/en';
	meSpeak.loadConfig("scripts/mespeak/mespeak_config.json");
	//meSpeak.loadVoice('scripts/mespeak/voices/en/en-us.json');
	meSpeak.loadVoice('scripts/mespeak/voices/'+speakVoice+'.json');
	//meSpeak.speak('hello world',{},toneSetup());
	
	
	
	var DiamondSound = function () {
		this.tone = new Tone();
		
		this.pitchCollection = [55, 57, 59, 61, 62, 64, 66, 67, 68, 69, 71, 73, 75, 76, 78, 80, 82, 83];
		this.pitch = this.pitchCollection[Math.floor(Math.random() * (this.pitchCollection.length))];
		
		this.tremolo = new Tone.Tremolo({
			"frequency":8,
			"type":"sine",
			"depth":0.6,
			"spread":0
			//"wet": 0.8
		}).toMaster().start();
		
		this.synth = new Tone.SimpleSynth({
			"oscillator" : {
				"type" : "sine"
		 },
		 "envelope" : {
		 	"attack" : 2.0,
			"decay" : 0.5,
			"sustain" : 0.8,
			"release" : 2.0
		 }
		}).connect(this.tremolo);

		this.playerUtopalypse = new Tone.Player("data/Utopalypse.mp3").toMaster();
		this.playerDiamonds = new Tone.Player("data/diamonds_in_distopia.mp3").toMaster();
		this.playerKepler = new Tone.Player("data/Kepler_Star.mp3").toMaster();
			this.playerKepler.retrigger = 1;
		this.playerEnding = new Tone.Player("data/Ending_for_a_minute.mp3").toMaster();
		

		this.gainy = new Tone.Gain().toMaster();
		this.filt2 = new Tone.Filter(this.tone.midiToNote(this.pitch+12), "bandpass").connect(this.gainy);
		this.filt = new Tone.Filter(this.tone.midiToNote(this.pitch+12), "bandpass").connect(this.filt2);
		this.filt.Q.value = 9;
		this.filt.gain.value = 40;
		this.filt2.Q.value = 2;
		this.filt2.gain.value = 40;
		// this.ns = new Tone.Noise('pink').connect(this.filt);
		this.gainy.gain.value = 10.;
		
		this.synth.triggerAttackRelease("C4", "8n",{} , 0.25);
		
		meSpeak.setAudioContext(this.tone.context);
		meSpeak.speakToNode(this.filt);
		// if (meSpeak.isConfigLoaded() && meSpeak.isVoiceLoaded(speakVoice)) {
		// meSpeak.speak('Diamonds');
		// }
		
		this.playPitch = function () {
			this.synth.triggerAttackRelease(this.tone.midiToNote(this.pitch+12), 5);
		};

		this.triggerPitch = function () {
			this.synth.triggerAttackRelease(this.tone.midiToNote(this.pitch+12), 5);
			// socket.emit('triggerPitch', dSound.pitch);
		};
		
		
		this.playUtopalypse = function() {
			this.playerKepler.start();
			this.playerUtopalypse.start("+2");
			this.playerKepler.start("+4");
		};

		this.playDiamonds = function() {
			this.playerDiamonds.start();
		};

		this.playKepler = function() {
			this.playerKepler.start();
		};
		
		this.playEnding = function() {
			this.playerEnding.start();
		};
		
		
		this.triggerDiamonds = function() {
			this.synth.triggerAttackRelease(this.tone.midiToNote(this.pitch+12), 5);
			this.playerDiamonds.start();
		};
		
		this.speak = function(text) {
			this.pitch = this.pitchCollection[Math.floor(Math.random() * (this.pitchCollection.length))];
			var freq = this.tone.midiToNote(this.pitch+12);
			this.filt.frequency.value = (freq);
			this.filt2.frequency.value = (freq);
			var rate = Math.floor(Math.random() * (12.)+ 4.);
			this.tremolo.frequency.value = freq;
			
					// check for safety - iOS will fail if you try to say something and can't
			if (meSpeak.isConfigLoaded() && meSpeak.isVoiceLoaded(speakVoice)) {
				meSpeak.speak(text);
			}
			this.synth.triggerAttackRelease(freq, "4n",{} , 0.15);
		};
	}
	
	var dSound = new DiamondSound();


		
</script>
	
</div>
</body>
</html>
